# Copilot stack detection

This file was auto-generated by the assistant to summarize the repo stack and where to implement Entrega 5 (Sagas + Outbox mode).

## 1) Frameworks and main libraries
- Python project (pyproject.toml requires Python >=3.12)
- Web framework: Flask (see `requirements.txt` and `src/alpespartners/api/*` Blueprints)
- SQL ORM: SQLAlchemy (via Flask-SQLAlchemy)
- Messaging (local/dev): Apache Pulsar client present (`pulsar-client` in requirements)
- Avro support for Pulsar (`pulsar-client[avro]` present)
- Testing: pytest

## 2) Services and entry points
- alpespartner (container/service) — main monolith API
  - Docker Compose service: `alpespartner`
  - Exposed port (host -> container): 5000 -> 5000
  - Entrypoint: `entrypoint.sh` (see root)
  - Flask blueprints live under `src/alpespartners/api/`:
    - `campanias.py`, `cliente.py`, `pagos.py`
  - There is no separate `bff/` folder; the monolith contains API entrypoints.

- postgres (container/service) — Postgres DB
  - Docker Compose service: `postgres`
  - Exposed port: 54320 -> 5432 (host -> container)
  - DB URL used in compose (for `alpespartner`):
    - `postgresql+psycopg2://admin:admin10100101.@postgres:5432/postgres`

- Pulsar stack (local/dev)
  - broker (ports 6650, 8080 mapped)
  - zookeeper, bookie, pulsar-init, pulsar-manager
  - Pulsar is optional for cloud deployment (we will use DB Outbox in cloud)

## 3) Database schema (current models of interest)
- `ProcessedEvent` model (table `processed_events`) — used for idempotency
  - Columns: id (pk), aggregate_id, event_type, event_id, processed_at
  - Unique constraint on (aggregate_id, event_type, event_id)

- `OutboxEvent` model (table `outbox`) — lightweight existing model
  - Columns: id (pk), event_type, payload (JSON), status (string), created_at, updated_at
  - Note: this model already exists in `src/alpespartners/config/db.py`, but the schema may be incomplete for full DB Outbox requirements (no retry_count, last_error, topic, updated_at)

- Event store used in modules (e.g., campanias) lives in module infra but no centralized `saga_log` table currently exists.

## 4) Existing Saga / Orchestrator
- There is no explicit Saga Orchestrator class or `saga_log` table found in the codebase root. Some domain modules use domain events, outbox, and `processed_events` for idempotency; but a cross-cutting Saga coordinator and persistent Saga log (with steps) are missing.

## 5) Gaps to deliver "Entrega 5" with DB Outbox (Opción B)
- No `saga_log` table or Saga coordinator implementation found. We'll need to add `saga_log` migration and model.
- Current `outbox` model exists but needs extension (topic, retry_count, last_error, updated_at) for a robust DB Outbox in cloud mode.
- Worker/consumer to read outbox and execute event handling / advance saga steps is missing — must be implemented (as a lightweight worker or background scheduler inside the BFF or a separate process when running in Heroku).
- BFF: there is no standalone BFF; the monolith exposes APIs under `src/alpespartners/api/`. For Heroku it's acceptable to expose a single BFF process (we'll implement the Saga endpoints under a new `bff/` package or expand API blueprints).
- Migrations: repository does not include Alembic configs; we'll add lightweight migrations (Alembic) or a simple `create_all`-based startup migration for Heroku (acceptable for demo) and provide scripts.

## 6) Recommendation to implement Entrega 5 (short)
- Implement `DbOutboxBus` and `outbox_worker` in `src/alpespartners/infra/message_bus/`.
- Add `saga_log` model and `outbox` migration (use Alembic or a simple startup migration path for Heroku demo).
- Implement a Saga coordinator (simple orchestrator) under `src/alpespartners/bff/saga_orchestrator.py` or integrate into `src/alpespartners/api/saga.py`.
- Create BFF endpoints under `src/alpespartners/api/saga.py` to start a Saga, query saga log, and mock inventory/payment endpoints.
- Add Postman collection `postman/entrega5-saga.postman_collection.json` and `postman/env.json` with `BASE_URL`.

### Recent changes added by the assistant
- `src/alpespartners/infra/message_bus/db_outbox.py` — `DbOutboxBus` implementation (enqueue events into `outbox` table)
- `src/alpespartners/infra/message_bus/worker.py` — `OutboxWorker` that polls `outbox` and calls local HTTP mock endpoints to advance Saga steps
- `src/alpespartners/config/migrations.py` — lightweight create_all migrations for `outbox` and `saga_log`
- `src/alpespartners/api/saga.py` — new blueprint exposing `POST /saga/orders`, `GET /saga/orders/{id}`, and mock endpoints `/inventory/*` and `/payment/charge`
- `src/alpespartners/api/admin.py` — `POST /admin/db/migrate` endpoint to run startup migrations on demand
- `Procfile`, `postman/entrega5-saga.postman_collection.json`, `postman/env.json`, `Makefile` and `package.json` scripts for Postman/Newman execution

These changes implement a demo-capable DB Outbox mode and a minimal Saga flow backed by a persistent `saga_log`.

---
Generated: 2025-09-16
